name: CI-iOS

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build and Test using xcodebuild command
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_14.2.app
      
      - name: Xcode version
        run: /usr/bin/xcodebuild -version
      
      - name: xcodegen
        uses: xavierLowmiller/xcodegen-action@1.1.2
        with:
          spec: project.yml
          quiet: true

      - name: Generate project
        run: xcodegen generate

      - name: Regressive tests
        run: fastlane ci_iOS
      
      - name: ensure_keychain
        run: fastlane ensure_keychain
      
      - name: Archive
        run: fastlane release_sunnyDay
        env:
          GIT_AUTHORIZATION: ${{ secrets.GIT_AUTHORIZATION }}
          GIT_USER_EMAIL:  ${{ secrets.GIT_USER_EMAIL }}
          USER_NAME: ${{ secrets.USER_NAME }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          CI_BUILD_NUMBER: $GITHUB_RUN_NUMBER
      
      - name: upload testflight
        run: fastlane upload_testflight
        env:
          KEY_ID: ${{ secrets.KEY_ID }}
          ISSUER_ID: ${{ secrets.ISSUER_ID }}